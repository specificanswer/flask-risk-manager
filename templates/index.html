<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crypto Futures Trader</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .card {
        margin-bottom: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .position-card {
        border-left: 4px solid #198754;
      }

      .position-card.short {
        border-left: 4px solid #dc3545;
      }

      .flash-messages {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        max-width: 350px;
      }

      .toggle-form {
        cursor: pointer;
      }

      .nav-pills .nav-link.active {
        background-color: #0d6efd;
      }

      .profit {
        color: #198754;
        font-weight: bold;
      }

      .loss {
        color: #dc3545;
        font-weight: bold;
      }

      /* Additional styles for the enhanced UI */
      .form-range::-webkit-slider-thumb {
        background: #0d6efd;
      }

      .form-range::-moz-range-thumb {
        background: #0d6efd;
      }

      .form-range::-ms-thumb {
        background: #0d6efd;
      }

      .size-preset {
        min-width: 50px;
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container">
        <a class="navbar-brand" href="#">Crypto Futures Trader</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarNav"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <a class="nav-link active" href="{{ url_for('index') }}"
                >Dashboard</a
              >
            </li>
          </ul>
          <span class="navbar-text me-3">
            Exchange:
            <span class="badge bg-success">{{ status.exchange|upper }}</span>
          </span>
          <a href="{{ url_for('setup') }}" class="btn btn-outline-light btn-sm"
            >Change Exchange</a
          >
        </div>
      </div>
    </nav>

    <div class="container mt-4">
      <!-- Flash Messages -->
      <div class="flash-messages">
        {% with messages = get_flashed_messages(with_categories=true) %} {% if
        messages %} {% for category, message in messages %}
        <div
          class="alert alert-{{ category }} alert-dismissible fade show"
          role="alert"
        >
          {{ message }}
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="alert"
            aria-label="Close"
          ></button>
        </div>
        {% endfor %} {% endif %} {% endwith %}
      </div>

      <div class="row">
        <!-- Trading Status Card -->
        <div class="col-lg-4 mb-4">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">Trading Status</h5>
            </div>
            <div class="card-body">
              <p><strong>Exchange:</strong> {{ status.exchange|upper }}</p>
              <p>
                <strong>Can Trade:</strong>
                {% if status.can_trade %}
                <span class="badge bg-success">Yes</span>
                {% else %}
                <span class="badge bg-danger">No</span>
                {% endif %}
              </p>
              <p><strong>Status:</strong> {{ status.status_message }}</p>
              <p>
                <strong>Trades Today:</strong> {{ status.daily_trade_count }} /
                {{ status.max_trades_per_day }}
              </p>
              <p>
                <strong>Daily PnL:</strong>
                {% if status.daily_pnl > 0 %}
                <span class="profit">+${{ status.daily_pnl }}</span>
                {% elif status.daily_pnl < 0 %}
                <span class="loss">${{ status.daily_pnl }}</span>
                {% else %} ${{ status.daily_pnl }} {% endif %}
              </p>
              <p>
                <strong>Daily Loss Limit:</strong> ${{ status.daily_loss_limit
                }}
              </p>
              <p><strong>Max Loss Per Trade:</strong> $5.00</p>
              <p>
                <strong>Last Trade:</strong>
                {% if status.last_trade_time %} {{
                status.last_trade_time.split('T')[0] }} &nbsp;&nbsp; {{
                status.last_trade_time.split('T')[1].split('.')[0] |
                datetimeformat }} {% else %} None {% endif %}
              </p>
              <p>
                <strong>Cooldown Ends:</strong>
                {% if status.cooldown_ends %} {{
                status.cooldown_ends.split('T')[0] }} &nbsp;&nbsp; {{
                status.cooldown_ends.split('T')[1].split('.')[0] |
                datetimeformat }} {% else %} N/A {% endif %}
              </p>
            </div>
          </div>
        </div>

        <!-- Open Positions Card -->
        <div class="col-lg-8 mb-4">
          <div class="card">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">Open Positions</h5>
            </div>
            <div class="card-body">
              {% if positions %}
              <div class="row">
                {% for position in positions %}
                <div class="col-md-6 mb-3">
                  <div
                    class="card position-card {% if position.side == 'short' %}short{% endif %}"
                  >
                    <div class="card-body">
                      <h6 class="card-title">{{ position.symbol }}</h6>
                      <p class="mb-1">
                        <strong>Side:</strong>
                        {% if position.side == 'long' %}
                        <span class="badge bg-success">LONG</span>
                        {% else %}
                        <span class="badge bg-danger">SHORT</span>
                        {% endif %}
                      </p>
                      <p class="mb-1">
                        <strong>Size:</strong> {{ position.contracts }}
                      </p>
                      <p class="mb-1">
                        <strong>Entry Price:</strong> {{
                        position.entryPrice|default('N/A') }}
                      </p>
                      <p class="mb-1">
                        <strong>Leverage:</strong> {{
                        position.leverage|default('N/A') }}x
                      </p>
                      <p class="mb-1">
                        <strong>Unrealized PnL:</strong>
                        {% if position.unrealizedPnl is defined %} {% if
                        position.unrealizedPnl > 0 %}
                        <span class="profit"
                          >+${{ position.unrealizedPnl }}</span
                        >
                        {% else %}
                        <span class="loss">${{ position.unrealizedPnl }}</span>
                        {% endif %} {% else %}
                        <span>N/A</span>
                        {% endif %}
                      </p>
                      <form
                        action="{{ url_for('close_position') }}"
                        method="post"
                        class="mt-2"
                      >
                        <input
                          type="hidden"
                          name="symbol"
                          value="{{ position.symbol }}"
                        />
                        <button type="submit" class="btn btn-danger btn-sm">
                          Close Position
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="alert alert-secondary">
                <i class="bi bi-info-circle me-2"></i> No open positions
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <!-- Trading Forms Tabs -->
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header bg-success text-white">
              <ul class="nav nav-pills card-header-pills" role="tablist">
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link active"
                    id="place-trade-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#place-trade"
                    type="button"
                    role="tab"
                    aria-controls="place-trade"
                    aria-selected="true"
                  >
                    Place Trade
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button
                    class="nav-link"
                    id="update-pnl-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#update-pnl"
                    type="button"
                    role="tab"
                    aria-controls="update-pnl"
                    aria-selected="false"
                  >
                    Update PnL
                  </button>
                </li>
              </ul>
            </div>
            <div class="card-body">
              <div class="tab-content">
                <!-- Place Trade Tab -->
                <div
                  class="tab-pane fade show active"
                  id="place-trade"
                  role="tabpanel"
                  aria-labelledby="place-trade-tab"
                >
                  <form action="{{ url_for('place_trade') }}" method="post">
                    {{ trade_form.hidden_tag() }}

                    <div class="mb-3">
                      <label for="symbol" class="form-label">Symbol</label>
                      <div class="input-group">
                        <input
                          type="text"
                          class="form-control"
                          id="symbol"
                          name="symbol"
                          required
                          placeholder="e.g. BTC/USDT or BTCUSDT"
                          value="SOL/USDT"
                        />
                        <button
                          class="btn btn-outline-secondary"
                          type="button"
                          id="refreshPrice"
                        >
                          <i class="bi bi-arrow-clockwise"></i> Get Price
                        </button>
                      </div>
                    </div>

                    <div class="mb-3">
                      <label for="side" class="form-label">Side</label>
                      <div class="btn-group w-100" role="group">
                        <input
                          type="radio"
                          class="btn-check"
                          name="side"
                          id="side-buy"
                          value="buy"
                          autocomplete="off"
                          checked
                        />
                        <label class="btn btn-outline-success" for="side-buy"
                          >Buy (Long)</label
                        >

                        <input
                          type="radio"
                          class="btn-check"
                          name="side"
                          id="side-sell"
                          value="sell"
                          autocomplete="off"
                        />
                        <label class="btn btn-outline-danger" for="side-sell"
                          >Sell (Short)</label
                        >
                      </div>
                    </div>

                    <!-- Enhanced Position Size with Slider -->
                    <div class="mb-3">
                      <label for="amount" class="form-label"
                        >Position Size (USD)</label
                      >
                      <div class="position-relative mb-2">
                        <input
                          type="range"
                          class="form-range"
                          id="amount_slider"
                          min="0"
                          max="2000"
                          step="1"
                          value="20"
                        />
                      </div>
                      <div
                        class="d-flex justify-content-between align-items-center"
                      >
                        <div class="input-group" style="max-width: 180px">
                          <span class="input-group-text">$</span>
                          <input
                            type="number"
                            class="form-control"
                            id="amount"
                            name="amount"
                            step="0.01"
                            min="0.01"
                            max="50"
                            value="1"
                            required
                          />
                        </div>
                        <div class="btn-group" role="group">
                          <button
                            type="button"
                            class="btn btn-outline-secondary btn-sm size-preset"
                            data-value="25"
                          >
                            25%
                          </button>
                          <button
                            type="button"
                            class="btn btn-outline-secondary btn-sm size-preset"
                            data-value="50"
                          >
                            50%
                          </button>
                          <button
                            type="button"
                            class="btn btn-outline-secondary btn-sm size-preset"
                            data-value="75"
                          >
                            75%
                          </button>
                          <button
                            type="button"
                            class="btn btn-outline-secondary btn-sm size-preset"
                            data-value="100"
                          >
                            Max
                          </button>
                        </div>
                      </div>
                      <div class="form-text">
                        <i class="bi bi-shield-fill-check text-success"></i>
                        Position protected by $5.00 max loss rule
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-6">
                        <div class="mb-3">
                          <label for="order_type" class="form-label"
                            >Order Type</label
                          >
                          <select
                            class="form-select"
                            id="order_type"
                            name="order_type"
                          >
                            <option value="market">Market</option>
                            <option value="limit">Limit</option>
                          </select>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="mb-3" id="price-group">
                          <label for="price" class="form-label"
                            >Limit Price</label
                          >
                          <input
                            type="number"
                            class="form-control"
                            id="price"
                            name="price"
                            step="any"
                            min="0"
                          />
                          <div class="form-text">Required for limit orders</div>
                        </div>
                      </div>
                    </div>

                    <!-- Advanced Options Section -->
                    <div class="accordion mb-3" id="advancedOptions">
                      <div class="accordion-item">
                        <h2 class="accordion-header" id="headingAdvanced">
                          <button
                            class="accordion-button"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#collapseAdvanced"
                            aria-expanded="true"
                            aria-controls="collapseAdvanced"
                          >
                            Advanced Options
                          </button>
                        </h2>
                        <div
                          id="collapseAdvanced"
                          class="accordion-collapse collapse show"
                          aria-labelledby="headingAdvanced"
                          data-bs-parent="#advancedOptions"
                        >
                          <div class="accordion-body">
                            <div class="row">
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label for="stop_loss" class="form-label"
                                    >Stop Loss</label
                                  >
                                  <input
                                    type="number"
                                    class="form-control"
                                    id="stop_loss"
                                    name="stop_loss"
                                    step="any"
                                    min="0"
                                  />
                                  <div class="form-text">
                                    Market order when triggered
                                  </div>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label for="take_profit" class="form-label"
                                    >Take Profit</label
                                  >
                                  <input
                                    type="number"
                                    class="form-control"
                                    id="take_profit"
                                    name="take_profit"
                                    step="any"
                                    min="0"
                                  />
                                  <div class="form-text">
                                    Limit order when triggered
                                  </div>
                                </div>
                              </div>
                            </div>

                            <!-- PnL Calculator Card -->
                            <div class="card bg-light mb-3">
                              <div class="card-body p-2">
                                <h6 class="card-title">Estimated PNL</h6>
                                <div class="row g-2">
                                  <div class="col-6">
                                    <div class="d-flex justify-content-between">
                                      <span>Stop-Loss:</span>
                                      <span id="sl_pnl" class="loss"
                                        >-$0.00 (0.00%)</span
                                      >
                                    </div>
                                  </div>
                                  <div class="col-6">
                                    <div class="d-flex justify-content-between">
                                      <span>Take-Profit:</span>
                                      <span id="tp_pnl" class="profit"
                                        >+$0.00 (0.00%)</span
                                      >
                                    </div>
                                  </div>
                                  <div class="col-12">
                                    <div class="d-flex justify-content-between">
                                      <span>Risk/Reward Ratio:</span>
                                      <span id="risk_reward">1:1.00</span>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <div class="row">
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label for="leverage" class="form-label"
                                    >Leverage</label
                                  >
                                  <select
                                    class="form-select"
                                    id="leverage"
                                    name="leverage"
                                  >
                                    <option value="1">1x</option>
                                    <option value="2">2x</option>
                                    <option value="3">3x</option>
                                    <option value="5">5x</option>
                                    <option value="10">10x</option>
                                    <option value="20">20x</option>
                                    <option value="50" selected>50x</option>
                                    <option value="100">100x</option>
                                  </select>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="mb-3">
                                  <label for="margin_mode" class="form-label"
                                    >Margin Mode</label
                                  >
                                  <select
                                    class="form-select"
                                    id="margin_mode"
                                    name="margin_mode"
                                  >
                                    <option value="isolated" selected>
                                      Isolated
                                    </option>
                                    <option value="cross">Cross</option>
                                  </select>
                                </div>
                              </div>
                            </div>

                            <!-- Liquidation Price Display -->
                            <div class="mb-3">
                              <div class="card bg-light mb-3">
                                <div class="card-body p-2">
                                  <div
                                    class="d-flex justify-content-between align-items-center"
                                  >
                                    <span>Liquidation Price:</span>
                                    <span
                                      id="liquidation_price"
                                      class="fw-bold text-danger"
                                      >--</span
                                    >
                                  </div>
                                  <div class="progress" style="height: 5px">
                                    <div
                                      id="liquidation_indicator"
                                      class="progress-bar bg-danger"
                                      role="progressbar"
                                      style="width: 0%"
                                    ></div>
                                  </div>
                                </div>
                              </div>
                            </div>

                            <div class="mb-3 form-check">
                              <input
                                type="checkbox"
                                class="form-check-input"
                                id="post_only"
                                name="post_only"
                              />
                              <label class="form-check-label" for="post_only"
                                >Post Only (Maker Only)</label
                              >
                              <div class="form-text">
                                For limit orders, ensures order is a maker
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <button type="submit" class="btn btn-success w-100">
                      <i class="bi bi-check-circle me-2"></i>Place Trade
                    </button>
                  </form>
                </div>

                <!-- Update PnL Tab -->
                <div
                  class="tab-pane fade"
                  id="update-pnl"
                  role="tabpanel"
                  aria-labelledby="update-pnl-tab"
                >
                  <form action="{{ url_for('update_pnl') }}" method="post">
                    {{ pnl_form.hidden_tag() }}
                    <div class="mb-3">
                      <label for="pnl_amount" class="form-label"
                        >PnL Amount (USD)</label
                      >
                      <input
                        type="number"
                        class="form-control"
                        id="pnl_amount"
                        name="amount"
                        step="0.01"
                        required
                      />
                      <div class="form-text">
                        Enter positive value for profit, negative for loss
                      </div>
                    </div>
                    <button type="submit" class="btn btn-warning w-100">
                      <i class="bi bi-gear me-2"></i>Update PnL
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Trade History Card -->
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div
              class="card-header bg-secondary text-white d-flex justify-content-between align-items-center"
            >
              <h5 class="mb-0">Trade History</h5>
              <a
                href="{{ url_for('check_orders') }}"
                class="btn btn-outline-light btn-sm"
              >
                <i class="bi bi-arrow-repeat"></i> Check Order Status
              </a>
            </div>
            <div class="card-body">
              {% if status.trades_history %}
              <div class="table-responsive">
                <table class="table table-sm table-hover">
                  <thead>
                    <tr>
                      <th>Time</th>
                      <th>Symbol</th>
                      <th>Side</th>
                      <th>Size</th>
                      <th>Price</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for trade in status.trades_history %}
                    <tr>
                      <td>
                        {{ trade.time.split('T')[0] }} &nbsp;&nbsp; {{
                        trade.time.split('T')[1].split('.')[0] | datetimeformat
                        }} {% if trade.status %}
                        <span
                          class="badge {% if trade.status == 'filled' %}bg-success{% elif trade.status == 'pending' %}bg-warning{% else %}bg-secondary{% endif %} ms-2"
                        >
                          {{ trade.status }}
                        </span>
                        {% endif %}
                      </td>
                      <td>{{ trade.symbol }}</td>
                      <td>
                        {% if trade.side == 'buy' %}
                        <span class="badge bg-success">BUY</span>
                        {% else %}
                        <span class="badge bg-danger">SELL</span>
                        {% endif %}
                      </td>
                      <td>${{ trade.amount }}</td>
                      <td>{{ trade.price }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% else %}
              <div class="alert alert-secondary">
                <i class="bi bi-info-circle me-2"></i> No trade history
                available
              </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Position History Card -->
    <div class="card mt-4">
      <div
        class="card-header bg-primary text-white d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0">Position History</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>Time</th>
                <th>Symbol</th>
                <th>Type</th>
                <th>Size</th>
                <th>Entry</th>
                <th>Exit</th>
                <th>Realized PNL</th>
                <th>Fees</th>
              </tr>
            </thead>
            <tbody id="position-history-table">
              {% if status.position_history %} {% for position in
              status.position_history %}
              <tr>
                <td>
                  {{ position.close_time.split('T')[0] }} &nbsp;&nbsp; {{
                  position.close_time.split('T')[1].split('.')[0] |
                  datetimeformat }}
                </td>
                <td>{{ position.symbol }}</td>
                <td>
                  {% if position.side == 'long' %}
                  <span class="badge bg-success">LONG</span>
                  {% else %}
                  <span class="badge bg-danger">SHORT</span>
                  {% endif %}
                </td>
                <td>${{ position.size }}</td>
                <td>{{ position.entry_price }}</td>
                <td>{{ position.exit_price }}</td>
                <td
                  class="{% if position.realized_pnl > 0 %}profit{% elif position.realized_pnl < 0 %}loss{% endif %}"
                >
                  ${{ position.realized_pnl }}
                </td>
                <td>${{ position.fees }}</td>
              </tr>
              {% endfor %} {% else %}
              <tr>
                <td colspan="8" class="text-center">No closed positions yet</td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <footer class="bg-dark text-white py-3 mt-4">
      <div class="container text-center">
        <p class="mb-0">Crypto Futures Trader &copy; 2025</p>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css"></script>
    <script>
      // Calculate PNL and other values
      function updateCalculations() {
        const side = document.querySelector('input[name="side"]:checked').value;
        const orderType = document.getElementById("order_type").value;
        let price = parseFloat(document.getElementById("price").value) || 0;
        const amount = parseFloat(document.getElementById("amount").value) || 0;
        const leverage =
          parseFloat(document.getElementById("leverage").value) || 1;
        const stopLoss =
          parseFloat(document.getElementById("stop_loss").value) || 0;
        const takeProfit =
          parseFloat(document.getElementById("take_profit").value) || 0;

        // For market orders where price isn't set, try to make a reasonable estimate
        if (price === 0 && orderType === "market") {
          // If stop loss or take profit is set, use the average as a price estimate
          if (stopLoss > 0 && takeProfit > 0) {
            price = (stopLoss + takeProfit) / 2;
          } else if (stopLoss > 0) {
            price = stopLoss * 1.005; // Assume price is 0.5% above stop loss for longs
          } else if (takeProfit > 0) {
            price = takeProfit * 0.995; // Assume price is 0.5% below take profit for longs
          }
        }

        // Skip calculations if we're still missing essential values
        if (price === 0 || amount === 0) return;

        // Update price field if we estimated a price
        if (
          orderType === "market" &&
          price > 0 &&
          !document.getElementById("price").value
        ) {
          document.getElementById("price").value = price.toFixed(2);
        }

        // Calculate PNL for stop loss
        if (stopLoss > 0) {
          let slPnlAmount, slPnlPercent;

          // Calculate the percentage change
          if (side === "buy") {
            // For long positions: percentage change is (exit - entry) / entry
            slPnlPercent = ((stopLoss - price) / price) * 100;
          } else {
            // For short positions: percentage change is (entry - exit) / entry
            slPnlPercent = ((price - stopLoss) / price) * 100;
          }

          // Calculate the actual PnL amount based on position size and percentage
          slPnlAmount = amount * (slPnlPercent / 100);

          const slPnlElement = document.getElementById("sl_pnl");
          slPnlElement.textContent = `${
            slPnlAmount.toFixed(2) > 0 ? "+" : ""
          }$${slPnlAmount.toFixed(2)} (${slPnlPercent.toFixed(2)}%)`;
          slPnlElement.className = slPnlAmount >= 0 ? "profit" : "loss";
        }

        // Calculate PNL for take profit
        if (takeProfit > 0) {
          let tpPnlAmount, tpPnlPercent;

          // Calculate the percentage change
          if (side === "buy") {
            // For long positions: percentage change is (exit - entry) / entry
            tpPnlPercent = ((takeProfit - price) / price) * 100;
          } else {
            // For short positions: percentage change is (entry - exit) / entry
            tpPnlPercent = ((price - takeProfit) / price) * 100;
          }

          // Calculate the actual PnL amount based on position size and percentage
          tpPnlAmount = amount * (tpPnlPercent / 100);

          const tpPnlElement = document.getElementById("tp_pnl");
          tpPnlElement.textContent = `${
            tpPnlAmount.toFixed(2) > 0 ? "+" : ""
          }$${tpPnlAmount.toFixed(2)} (${tpPnlPercent.toFixed(2)}%)`;
          tpPnlElement.className = tpPnlAmount >= 0 ? "profit" : "loss";
        }

        // Calculate risk-reward ratio if both SL and TP are set
        if (stopLoss > 0 && takeProfit > 0) {
          let slAmount, tpAmount;
          if (side === "buy") {
            slAmount = Math.abs(stopLoss - price);
            tpAmount = Math.abs(takeProfit - price);
          } else {
            slAmount = Math.abs(price - stopLoss);
            tpAmount = Math.abs(price - takeProfit);
          }

          const ratio = (tpAmount / slAmount).toFixed(2);
          document.getElementById("risk_reward").textContent = `1:${ratio}`;
        }

        // Update liquidation price
        calculateLiquidationPrice();
      }

      function calculateLiquidationPrice() {
        const side = document.querySelector('input[name="side"]:checked').value;
        const price = parseFloat(document.getElementById("price").value) || 0;
        const leverage =
          parseFloat(document.getElementById("leverage").value) || 1;
        const marginMode = document.getElementById("margin_mode").value;

        // Skip calculations if we're missing essential values
        if (price === 0) return;

        // Simple liquidation calculation
        let liquidationPrice;
        if (side === "buy") {
          // For long positions, liquidation price is below entry
          liquidationPrice = price * (1 - (1 / leverage) * 0.95);
        } else {
          // For short positions, liquidation price is above entry
          liquidationPrice = price * (1 + (1 / leverage) * 0.95);
        }

        // Display the liquidation price
        document.getElementById("liquidation_price").textContent =
          liquidationPrice.toFixed(2);

        // Calculate distance to liquidation as percentage
        const distancePercentage = Math.abs(
          ((liquidationPrice - price) / price) * 100
        );

        // Update liquidation indicator
        const indicatorWidth = Math.min(100, (10 / distancePercentage) * 100);
        document.getElementById(
          "liquidation_indicator"
        ).style.width = `${indicatorWidth}%`;
      }

      // JavaScript to handle the order type selection
      document
        .getElementById("order_type")
        .addEventListener("change", function () {
          const isLimit = this.value === "limit";
          const priceField = document.getElementById("price");
          const priceGroup = document.getElementById("price-group");
          const postOnlyCheckbox = document.getElementById("post_only");

          if (isLimit) {
            // Limit order - price is required and enabled
            priceField.setAttribute("required", "");
            priceField.disabled = false;
            priceField.classList.remove("bg-light");
            priceGroup.classList.remove("text-muted");
            if (priceField.getAttribute("data-original-placeholder")) {
              priceField.placeholder = priceField.getAttribute(
                "data-original-placeholder"
              );
            }
            postOnlyCheckbox.disabled = false;
          } else {
            // Market order - price is ignored
            priceField.removeAttribute("required");

            // Store original placeholder if not already stored
            if (!priceField.getAttribute("data-original-placeholder")) {
              priceField.setAttribute(
                "data-original-placeholder",
                priceField.placeholder || ""
              );
            }

            // Visual indicators that price will be ignored
            priceField.placeholder = "Not used for market orders";
            priceField.classList.add("bg-light");
            priceGroup.classList.add("text-muted");

            postOnlyCheckbox.checked = false;
            postOnlyCheckbox.disabled = true;
          }

          // Always trigger calculation when order type changes
          updateCalculations();
        });

      // Get Price button handler
      document
        .getElementById("refreshPrice")
        .addEventListener("click", async function () {
          const symbolField = document.getElementById("symbol");
          let symbol = symbolField.value.trim();

          if (!symbol) {
            alert("Please enter a valid symbol first.");
            return;
          }

          try {
            // Show loading state
            this.innerHTML =
              '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
            this.disabled = true;

            console.log("Original symbol:", symbol);

            // Call the API endpoint to get current ticker data
            // Use a simpler approach - pass the symbol as-is and let the backend handle formatting
            const response = await fetch(`/api/ticker/${symbol}`);

            const responseText = await response.text();
            console.log("Raw response:", responseText);

            let data;
            try {
              data = JSON.parse(responseText);
            } catch (parseError) {
              console.error("Failed to parse JSON:", parseError);
              console.error("Response text:", responseText);
              throw new Error("Invalid response from server (not JSON)");
            }

            console.log("Parsed data:", data);

            if (data.error) {
              throw new Error(data.error);
            }

            if (!data.last) {
              throw new Error("No price data returned from server");
            }

            // Update the price field with the current price
            const priceField = document.getElementById("price");
            priceField.value = data.last;
            console.log("Updated price to:", data.last);

            // Restore button state
            this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Get Price';
            this.disabled = false;

            // Trigger calculations
            updateCalculations();
          } catch (error) {
            console.error("Error fetching price:", error);
            alert(`Failed to get price: ${error.message}`);

            // Restore button state
            this.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Get Price';
            this.disabled = false;
          }
        });

      // Utility function to fetch price when symbol changes
      function setupSymbolChangeHandler() {
        const symbolField = document.getElementById("symbol");

        symbolField.addEventListener("change", function () {
          // Auto-fetch price when symbol changes
          const symbol = this.value.trim();
          if (symbol) {
            document.getElementById("refreshPrice").click();
          }
        });
      }

      // Auto-dismiss flash messages after 5 seconds
      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(function () {
          const alerts = document.querySelectorAll(".alert");
          alerts.forEach(function (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
          });
        }, 5000);

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(
          document.querySelectorAll('[data-bs-toggle="tooltip"]')
        );
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Initial check for order type
        const orderTypeSelect = document.getElementById("order_type");
        if (orderTypeSelect) {
          orderTypeSelect.dispatchEvent(new Event("change"));
        }

        // Position size slider logic - revised to use max position size of 2000
        const amountSlider = document.getElementById("amount_slider");
        const amountInput = document.getElementById("amount");
        const maxPositionSize = 2000; // Reset to 2000

        // Update input when slider changes
        if (amountSlider) {
          amountSlider.addEventListener("input", function () {
            if (amountInput) {
              amountInput.value = parseFloat(this.value).toFixed(0);
              updateCalculations();
              // Save to localStorage
              localStorage.setItem("trading_amount", amountInput.value);
            }
          });
        }

        // Update slider when input changes
        if (amountInput) {
          amountInput.addEventListener("input", function () {
            if (amountSlider) {
              let value = parseFloat(this.value);
              if (isNaN(value)) value = 0;
              if (value > maxPositionSize) value = maxPositionSize;
              amountSlider.value = value;
              updateCalculations();
              // Save to localStorage
              localStorage.setItem("trading_amount", value);
            }
          });
        }

        // Size preset buttons
        document.querySelectorAll(".size-preset").forEach((button) => {
          button.addEventListener("click", function () {
            const percentage = parseFloat(this.dataset.value) / 100;
            const newValue = Math.round(2000 * percentage); // Use 2000 as max and round to whole number
            amountInput.value = newValue;
            amountSlider.value = newValue;
            updateCalculations();

            // Save to localStorage
            localStorage.setItem("trading_amount", newValue);
          });
        });

        // Add listeners for stop-loss, take-profit and leverage
        document
          .getElementById("stop_loss")
          .addEventListener("input", updateCalculations);
        document
          .getElementById("take_profit")
          .addEventListener("input", updateCalculations);
        document
          .getElementById("leverage")
          .addEventListener("change", updateCalculations);
        document
          .getElementById("price")
          .addEventListener("input", updateCalculations);

        // Add listeners for side changes
        document.querySelectorAll('input[name="side"]').forEach((radio) => {
          radio.addEventListener("change", updateCalculations);
        });

        // Setup symbol change handler
        setupSymbolChangeHandler();

        // Initialize calculations
        updateCalculations();
      });
    </script>

    <script>
      // Form value persistence
      document.addEventListener("DOMContentLoaded", function () {
        // Get all form elements we want to save
        const formElements = [
          "symbol",
          "amount",
          "order_type",
          "price",
          "stop_loss",
          "take_profit",
          "leverage",
          "margin_mode",
        ];

        // Restore saved values on page load
        formElements.forEach((id) => {
          const savedValue = localStorage.getItem(`trading_${id}`);
          const element = document.getElementById(id);

          if (element && savedValue !== null) {
            if (element.type === "checkbox") {
              element.checked = savedValue === "true";
            } else if (element.tagName === "SELECT") {
              element.value = savedValue;
              // Trigger change event to handle any dependencies
              element.dispatchEvent(new Event("change"));
            } else {
              // For amount input, make sure it doesn't exceed max
              if (id === "amount") {
                element.value = Math.min(parseFloat(savedValue), 2000);
              } else {
                element.value = savedValue;
              }
            }
          }
        });

        // Special case for side radio buttons
        const savedSide = localStorage.getItem("trading_side");
        if (savedSide) {
          const sideInput = document.querySelector(
            `input[name="side"][value="${savedSide}"]`
          );
          if (sideInput) {
            sideInput.checked = true;
          }
        }

        // Save values when form elements change
        formElements.forEach((id) => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener("change", function () {
              if (this.type === "checkbox") {
                localStorage.setItem(`trading_${id}`, this.checked);
              } else {
                localStorage.setItem(`trading_${id}`, this.value);
              }
            });

            // For text inputs, also save on keyup with a delay
            if (
              element.tagName === "INPUT" &&
              (element.type === "text" || element.type === "number")
            ) {
              element.addEventListener("input", function () {
                // Use a short timeout to avoid saving on every keystroke
                clearTimeout(element.saveTimeout);
                element.saveTimeout = setTimeout(() => {
                  localStorage.setItem(`trading_${id}`, this.value);
                }, 500);
              });
            }
          }
        });

        // Handle side radio buttons
        document.querySelectorAll('input[name="side"]').forEach((radio) => {
          radio.addEventListener("change", function () {
            if (this.checked) {
              localStorage.setItem("trading_side", this.value);
            }
          });
        });

        // Also save post_only checkbox
        const postOnlyCheckbox = document.getElementById("post_only");
        if (postOnlyCheckbox) {
          // Restore
          const savedPostOnly = localStorage.getItem("trading_post_only");
          if (savedPostOnly !== null) {
            postOnlyCheckbox.checked = savedPostOnly === "true";
          }

          // Save on change
          postOnlyCheckbox.addEventListener("change", function () {
            localStorage.setItem("trading_post_only", this.checked);
          });
        }

        // Force update calculations after restoring values
        if (typeof updateCalculations === "function") {
          updateCalculations();
        }
      });
    </script>
  </body>
</html>
